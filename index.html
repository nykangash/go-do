<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-do Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* --- Global & Dark Mode --- */
        body { font-family: 'Inter', sans-serif; background-color: #1f2a44; color: #e2e8f0; overscroll-behavior-x: none; transition: background-color 0.3s, color 0.3s; }
        .board-container { display: flex; overflow-x: auto; padding: 20px; gap: 16px; min-height: calc(100vh - 150px); align-items: flex-start; }
        .column { background-color: #2d3748; border-radius: 12px; width: 300px; min-width: 200px; max-width: 500px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: calc(100vh - 200px); resize: horizontal; overflow: hidden; position: relative; cursor: move; transition: background-color 0.2s; }
        .column:hover { overflow: visible; }
        .column-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4b5563; cursor: default; position: relative; }
        .column-title { font-weight: 600; color: #e2e8f0; cursor: pointer; flex-grow: 1; padding: 4px 0; }
        .column-title-input { font-weight: 600; color: #e2e8f0; border: none; background-color: #374151; padding: 4px; width: calc(100% - 30px); outline: 2px solid #60a5fa; border-radius: 4px; }
        .column-menu-btn { color: #9ca3af; background: none; border: none; cursor: pointer; padding: 4px 8px; line-height: 1; font-size: 1.1rem; border-radius: 4px; }
        .column-menu-btn:hover { color: #e2e8f0; background-color: #4b5563; }
        .add-card-area { padding: 12px; border-top: 1px solid #4b5563; }
        .new-task-input { width: 100%; padding: 8px 10px; border: 1px solid #4b5563; border-radius: 6px; margin-bottom: 8px; box-sizing: border-box; background-color: #2d3748; color: #e2e8f0; }
        .add-column-btn { background-color: #374151; color: #e2e8f0; padding: 10px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; width: 300px; flex-shrink: 0; }
        .add-column-btn:hover { background-color: #4b5563; }
        .add-column-btn-container { padding: 0 20px 20px 20px; }
        .subtask-item input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid #60a5fa; border-radius: 50%; background-color: transparent; cursor: pointer; position: relative; transition: all 0.2s ease-in-out; flex-shrink: 0; }
        .subtask-item input[type="checkbox"]:checked { background-color: #60a5fa; border-color: #60a5fa; }
        .subtask-item input[type="checkbox"]:checked::after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: translate(-50%, -60%) rotate(45deg); display: block; }
        .subtask-item span { flex-grow: 1; color: #cbd5e1; font-family: 'Roboto', sans-serif; font-size: 0.85rem; line-height: 1.3; transition: color 0.2s, text-decoration 0.2s; }
        .subtask-item span.completed { text-decoration: line-through; color: #9ca3af; }
        .delete-subtask-btn { color: #9ca3af; background: none; border: none; cursor: pointer; padding: 4px; line-height: 1; font-size: 0.9rem; }
        .delete-subtask-btn:hover { color: #f87171; }
        .subtask-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
        .subtask-list-container { margin-top: 8px; padding-left: 10px; display: flex; flex-direction: column; gap: 6px; }
        .add-subtask-form { display: flex; gap: 8px; margin-top: 8px; padding-left: 10px; }
        .new-subtask-input { flex-grow: 1; padding: 6px 8px; border: 1px solid #4b5563; border-radius: 4px; background-color: #374151; color: #e2e8f0; font-size: 0.9em; }
        .confirm-add-subtask-btn { padding: 6px 10px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .confirm-add-subtask-btn:hover { background-color: #1d4ed8; }
        .task-list { padding: 8px 12px; overflow-y: auto; flex-grow: 1; min-height: 60px; }
        .task-item { border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: grab; display: flex; flex-direction: column; word-wrap: break-word; overflow-wrap: break-word; position: relative; transition: box-shadow 0.2s; }
        .task-item:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .task-main-content { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .task-item p.task-text { flex-grow: 1; margin-right: 8px; font-family: 'Roboto', sans-serif; font-size: 0.95rem; line-height: 1.4; }
        .star-btn { position: absolute; top: 6px; right: 6px; background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.2s, color 0.2s; z-index: 10; padding: 4px; }
        .task-item:hover .star-btn { opacity: 1; }
        .star-btn:hover { color: #facc15; }
        .star-btn.starred { opacity: 1; color: #facc15; }
        .task-controls { display: none; }
        .task-item.dragging { opacity: 0.5; border: 2px dashed #60a5fa; }
        .column.drag-over .task-list { background-color: #4b5563; outline: 2px dashed #60a5fa; outline-offset: -2px; border-radius: 8px; }
        .board-container::-webkit-scrollbar, .task-list::-webkit-scrollbar, .column::-webkit-scrollbar { width: 8px; height: 8px; }
        .board-container::-webkit-scrollbar-thumb, .task-list::-webkit-scrollbar-thumb, .column::-webkit-scrollbar-thumb { background-color: #6b7280; border-radius: 4px; }
        .board-container::-webkit-scrollbar-track, .task-list::-webkit-scrollbar-track, .column::-webkit-scrollbar-track { background-color: #2d3748; }
        input:focus, button:focus-visible { outline: 2px solid #60a5fa !important; outline-offset: 1px; }
        /* --- Sidebar --- */
        #sidebar { background-color: #111827; transition: transform 0.3s ease-in-out; }
        #sidebarOverlay { transition: opacity 0.3s ease-in-out; }
        #sidebarOverlay.hidden { display: none; opacity: 0; }
        .sidebar-board-item { display: flex; justify-content: space-between; align-items: center; width: 100%; text-align: left; padding: 10px 15px; border-radius: 6px; transition: background-color 0.2s; }
        .sidebar-board-item:hover { background-color: #374151; }
        .sidebar-board-item.active { background-color: #2563eb; font-weight: bold; }
        .sidebar-board-item span { flex-grow: 1; margin-left: 12px; } /* Add margin for spacing */
        .sidebar-board-item i { width: 16px; text-align: center; }
        .sidebar-board-delete-btn { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; border-radius: 4px; font-size: 0.9rem; flex-shrink: 0; }
        .sidebar-board-delete-btn:hover { color: #f87171; background-color: #581c874d; } /* Added subtle bg on hover */
        #completedTasksBtn { display: block; width: 100%; text-align: left; padding: 10px 15px; border-radius: 6px; transition: background-color 0.2s; display: flex; align-items: center; gap: 12px; }
        #completedTasksBtn:hover { background-color: #374151; }
        /* --- Theme Toggle --- */
        #themeToggleBtn #themeToggleIndicator { transition: transform 0.2s ease-in-out; }
        #themeToggleBtn.dark #themeToggleIndicator { transform: translateX(1.25rem); }
        #themeToggleBtn.dark { background-color: #3b82f6; }
        #themeToggleBtn:not(.dark) { background-color: #cbd5e1; }
        #themeToggleBtn i { pointer-events: none; }
        /* --- Menus --- */
        .menu-base { position: absolute; z-index: 1000; background-color: #2d3748; border: 1px solid #4b5563; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 8px; display: none; flex-direction: column; gap: 4px; width: 200px; }
        .menu-item { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s; color: #e2e8f0; font-size: 0.9rem; gap: 10px; }
        .menu-item:hover { background-color: #374151; }
        .menu-item i { width: 16px; text-align: center; }
        .menu-item.delete { color: #f87171; }
        .menu-item.delete:hover { background-color: #7f1d1d; color: #fee2e2; }
        hr.menu-divider { border-top: 1px solid #4b5563; margin: 4px 0; }
        .context-menu-color-swatch { width: 16px; height: 16px; border-radius: 50%; margin-right: 0px; border: 1px solid #6b7280; }
        .submenu { position: relative; }
        .submenu-content { position: absolute; left: 100%; top: -8px; /* Adjust as needed */ display: none; }
        .submenu:hover .submenu-content { display: flex; }
        /* --- Light Mode --- */
        body.light-mode { background-color: #f9fafb; color: #111827; }
        body.light-mode .column { background-color: #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        body.light-mode .column-header { border-bottom-color: #d1d5db; }
        body.light-mode .column-title { color: #111827; }
        body.light-mode .column-title-input { color: #111827; background-color: #f9fafb; }
        body.light-mode .task-list { background-color: #e5e7eb; }
        body.light-mode .column.drag-over .task-list { background-color: #d1d5db; }
        body.light-mode .add-card-area { border-top-color: #d1d5db; }
        body.light-mode .new-task-input { background-color: #f9fafb; color: #111827; border-color: #d1d5db; }
        body.light-mode .add-column-btn { background-color: #d1d5db; color: #1f2937; }
        body.light-mode .add-column-btn:hover { background-color: #9ca3af; }
        body.light-mode .delete-subtask-btn { color: #6b7280; }
        body.light-mode .delete-subtask-btn:hover { color: #ef4444; }
        body.light-mode .board-container::-webkit-scrollbar-thumb { background-color: #9ca3af; }
        body.light-mode .board-container::-webkit-scrollbar-track { background-color: #e5e7eb; }
        body.light-mode #sidebar { background-color: #ffffff; color: #111827; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
        body.light-mode #sidebar h3 { color: #374151; }
        body.light-mode #sidebar .sidebar-board-item:hover { background-color: #f3f4f6; }
        body.light-mode #completedTasksBtn:hover { background-color: #f3f4f6; }
        body.light-mode #sidebar .sidebar-board-item.active { background-color: #3b82f6; color: white; }
        body.light-mode #sidebar .sidebar-board-item.active i { color: #e0e7ff; } /* Lighter icon on active */
        body.light-mode #sidebar .sidebar-board-delete-btn { color: #6b7280; }
        body.light-mode #sidebar .sidebar-board-delete-btn:hover { color: #ef4444; background-color: #fee2e2; }
        body.light-mode #themeToggleBtn { background-color: #e5e7eb; }
        body.light-mode #themeToggleIndicator { background-color: #4b5563; }
        body.light-mode .menu-base { background-color: #ffffff; border-color: #d1d5db; color: #111827; }
        body.light-mode .menu-item { color: #111827; }
        body.light-mode .menu-item:hover { background-color: #f3f4f6; }
        body.light-mode hr.menu-divider { border-top-color: #d1d5db; }
        body.light-mode .column-menu-btn:hover { background-color: #cbd5e1; color: #1f2937; }
        body.light-mode .subtask-item span { color: #374151; }
        body.light-mode .subtask-item span.completed { color: #6b7280; }
        body.light-mode .subtask-item input[type="checkbox"]:checked::after { border-color: #1f2a44; }
        body.light-mode .subtask-item input[type="checkbox"] { border-color: #3b82f6; }

    </style>
</head>
<body class="text-gray-200">

    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white p-5 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 shadow-lg">
        <h2 class="text-2xl font-bold mb-6 flex justify-between items-center">
            Go-do Menu
            <button id="closeSidebarBtn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </h2>
        <h3 class="text-lg font-semibold mb-3 text-gray-400 uppercase tracking-wider">Boards</h3>
        <div id="sidebarBoardList" class="mb-6 max-h-60 overflow-y-auto pr-2">
            </div>
        <hr class="border-gray-700 my-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-400 uppercase tracking-wider">Archive</h3>
         <button id="completedTasksBtn" class="w-full text-left px-4 py-3 rounded hover:bg-gray-700 mb-3 flex items-center text-base">
            <i class="fas fa-check-circle mr-3"></i> Completed Tasks
        </button>
        <hr class="border-gray-700 my-4">
        <h3 class="text-lg font-semibold mb-3 text-gray-400 uppercase tracking-wider">Options</h3>
        <div class="flex items-center justify-between px-4 py-3 rounded">
            <span class="text-base flex items-center"><i class="fas fa-palette mr-3"></i>Theme</span>
            <button id="themeToggleBtn" class="relative inline-flex items-center h-6 rounded-full w-11 focus:outline-none">
                <span class="sr-only">Toggle Theme</span>
                 <i class="fas fa-sun absolute left-1 top-1/2 -translate-y-1/2 text-yellow-400 text-xs z-10"></i>
                <span id="themeToggleIndicator" class="inline-block w-4 h-4 transform bg-white rounded-full translate-x-1"></span>
                 <i class="fas fa-moon absolute right-1 top-1/2 -translate-y-1/2 text-gray-300 text-xs z-10"></i>
            </button>
        </div>
    </div>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <header class="p-4 bg-gray-800 text-white shadow-md flex justify-between items-center sticky top-0 z-30">
        <div class="flex items-center gap-4">
            <button id="openSidebarBtn" class="text-2xl hover:bg-gray-700 p-2 rounded-md">
                <i class="fas fa-bars"></i>
            </button>
             <span id="currentBoardNameHeader" class="text-xl font-semibold">Loading...</span>
        </div>
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
             <h1 class="text-4xl font-bold tracking-wider" style="font-family: 'Arial Black', Gadget, sans-serif; color: #60a5fa;">Go-do</h1>
        </div>
        <button id="addBoardBtnGlobal" class="add-board-btn text-white bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg text-lg flex items-center gap-2">
            <i class="fas fa-plus"></i>
            New Board
        </button>
    </header>

    <div id="boardContainer" class="board-container"></div>
    <div class="add-column-btn-container">
        <button id="addColumnBtnGlobal" class="add-column-btn">
            <i class="fas fa-plus mr-2"></i>Add New List
        </button>
    </div>

    <div id="taskColorContextMenu" class="menu-base"></div>
    <div id="columnContextMenu" class="menu-base"></div>

    <script>
        // --- DOM Selection ---
        const body = document.body;
        const boardContainer = document.getElementById('boardContainer');
        const addColumnBtnGlobal = document.getElementById('addColumnBtnGlobal');
        const taskColorContextMenu = document.getElementById('taskColorContextMenu');
        const columnContextMenu = document.getElementById('columnContextMenu');
        const addBoardBtnGlobal = document.getElementById('addBoardBtnGlobal');
        const openSidebarBtn = document.getElementById('openSidebarBtn');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarBoardList = document.getElementById('sidebarBoardList');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeToggleIndicator = document.getElementById('themeToggleIndicator');
        const completedTasksBtn = document.getElementById('completedTasksBtn');
        const currentBoardNameHeader = document.getElementById('currentBoardNameHeader');

        // --- Board State ---
        let appState = { boards: [], currentBoardId: null, nextBoardId: 1, nextColumnId: 1, nextTaskId: 1, nextSubTaskId: 1, theme: 'dark' };
        let draggedTask = null, sourceColumnId = null, draggedColumn = null;
        let currentContextMenuTask = { columnId: null, taskId: null };
        let currentContextMenuColumn = { columnId: null };

        // --- Preset Colors ---
        const PRESET_COLORS = [ { name: 'Gray', value: '#6B7280' }, { name: 'Red', value: '#EF4444' }, { name: 'Amber', value: '#F59E0B' }, { name: 'Green', value: '#10B981' }, { name: 'Blue', value: '#3B82F6' }, { name: 'Violet', value: '#8B5CF6' } ];
        const DEFAULT_TASK_COLOR = PRESET_COLORS[0].value;
        const COLUMN_COLORS = [ { name: 'Default', value: '#2d3748', light: '#e5e7eb' }, { name: 'Deep Blue', value: '#1e40af', light: '#dbeafe' }, { name: 'Forest Green', value: '#166534', light: '#d1fae5' }, { name: 'Rich Purple', value: '#581c87', light: '#f3e8ff' }, { name: 'Warm Red', value: '#991b1b', light: '#fee2e2' }, { name: 'Slate Gray', value: '#334155', light: '#e2e8f0' } ];
        const DEFAULT_COLUMN_COLOR = COLUMN_COLORS[0];

        // --- IndexedDB Setup ---
        const DB_NAME = 'GoDoDB_v4'; // Incremented
        const DB_VERSION = 1;
        const STORE_NAME = 'appState';
        let db;

        // --- IndexedDB Functions (No changes needed) ---
        function openDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onupgradeneeded = e => { e.target.result.objectStoreNames.contains(STORE_NAME) || e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id' }); }; request.onsuccess = e => { db = e.target.result; resolve(db); }; request.onerror = e => { console.error('IndexedDB error:', e.target.errorCode); reject('IndexedDB error: ' + e.target.errorCode); }; }); }
        async function saveAppState() { try { if (!db) await openDB(); const tx = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME); tx.put({ id: 'GoDoAppState', data: appState }); localStorage.setItem('GoDoTheme', appState.theme); } catch (error) { console.error('Error saving to IndexedDB:', error); } }
        async function loadAppState() { try { if (!db) db = await openDB(); const request = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).get('GoDoAppState'); request.onsuccess = (event) => { const result = event.target.result; let needsDefault = true; if (result && result.data && result.data.boards) { appState = result.data; needsDefault = appState.boards.length === 0; let maxB = 0, maxC = 0, maxT = 0, maxS = 0; appState.boards.forEach(b => { maxB = Math.max(maxB, parseInt((b.id || 'b-0').split('-')[1])); b.columns = b.columns || []; b.columns.forEach(c => { maxC = Math.max(maxC, parseInt((c.id || 'c-0').split('-')[1])); c.width = c.width || 300; c.color = c.color || DEFAULT_COLUMN_COLOR.value; c.tasks = c.tasks || []; c.tasks.forEach(t => { maxT = Math.max(maxT, parseInt((t.id || 't-0').split('-')[1])); t.color = t.color || DEFAULT_TASK_COLOR; t.subTasks = t.subTasks || []; t.isStarred = t.isStarred || false; t.createdAt = t.createdAt || Date.now(); t.subTasks.forEach(s => maxS = Math.max(maxS, parseInt((s.id || 's-0').split('-')[1]))); }); }); }); appState.nextBoardId = Math.max(appState.nextBoardId || 1, maxB + 1); appState.nextColumnId = Math.max(appState.nextColumnId || 1, maxC + 1); appState.nextTaskId = Math.max(appState.nextTaskId || 1, maxT + 1); appState.nextSubTaskId = Math.max(appState.nextSubTaskId || 1, maxS + 1); if (!appState.currentBoardId || !appState.boards.find(b => b.id === appState.currentBoardId)) { appState.currentBoardId = appState.boards.length > 0 ? appState.boards[0].id : null; } } if (needsDefault) { appState = { boards: [ { id: 'board-1', title: 'My First Board', columns: [ { id: 'col-1', title: 'To Do', tasks: [ {id: 'task-1', text: 'Explore Go-do!', color: PRESET_COLORS[4].value, subTasks: [ {id: 'subtask-1', text: 'Add a list', completed: false}, {id: 'subtask-2', text: 'Star a card', completed: false} ], isStarred: false, createdAt: Date.now()}, {id: 'task-2', text: 'Try Dark Mode!', color: PRESET_COLORS[2].value, subTasks: [], isStarred: true, createdAt: Date.now()-1000} ], width: 320, color: DEFAULT_COLUMN_COLOR.value }, { id: 'col-2', title: 'Done', tasks: [], width: 300, color: DEFAULT_COLUMN_COLOR.value }, ],} ], currentBoardId: 'board-1', nextBoardId: 2, nextColumnId: 3, nextTaskId: 3, nextSubTaskId: 3, theme: localStorage.getItem('GoDoTheme') || 'dark' }; } appState.theme = localStorage.getItem('GoDoTheme') || appState.theme || 'dark'; applyTheme(appState.theme); renderBoard(); }; request.onerror = () => { /* Fallback ... */ }; } catch (error) { /* Fallback ... */ } }

        // --- Utilities ---
        function getCurrentBoard() { return appState.boards.find(b => b.id === appState.currentBoardId) || null; }
        function getTaskById(columnId, taskId) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === columnId) : null; return c ? c.tasks.find(t => t.id === taskId) : null; }
        function getContrastingTextColor(backgroundColor) { const isLight = body.classList.contains('light-mode'); const c = COLUMN_COLORS.find(c => c.value === backgroundColor || c.light === backgroundColor); if (isLight && c && backgroundColor === c.light) return '#1f2937'; const h = backgroundColor.replace('#', ''); const [r, g, b] = [parseInt(h.substring(0, 2), 16), parseInt(h.substring(2, 4), 16), parseInt(h.substring(4, 6), 16)]; return Math.sqrt(0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b)) > 135 ? '#1f2937' : '#f3f4f6'; }

        // --- Theme & Sidebar ---
        function applyTheme(theme) { body.classList.toggle('light-mode', theme === 'light'); themeToggleBtn.classList.toggle('dark', theme !== 'light'); themeToggleIndicator.style.transform = theme === 'light' ? 'translateX(0.25rem)' : 'translateX(1.25rem)'; appState.theme = theme; }
        function toggleTheme() { applyTheme(appState.theme === 'dark' ? 'light' : 'dark'); saveAppState(); }
        function openSidebar() { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); }
        function closeSidebar() { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); }
        themeToggleBtn.addEventListener('click', toggleTheme);
        openSidebarBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        completedTasksBtn.addEventListener('click', () => alert('Completed tasks archive coming soon!'));


        // --- Board Rendering ---
        function renderBoardList() {
            sidebarBoardList.innerHTML = '';
            if (appState.boards.length === 0) { sidebarBoardList.innerHTML = '<p class="px-4 py-2 text-gray-400">No boards yet...</p>'; return; }
            appState.boards.forEach(board => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'sidebar-board-item';
                if (board.id === appState.currentBoardId) itemDiv.classList.add('active');

                const boardBtn = document.createElement('button');
                boardBtn.innerHTML = `<i class="fas fa-clipboard-list text-gray-400"></i><span>${board.title}</span>`;
                boardBtn.className = 'flex items-center gap-3 flex-grow'; // Takes up most space
                boardBtn.addEventListener('click', () => { switchBoard(board.id); closeSidebar(); });

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.className = 'sidebar-board-delete-btn';
                deleteBtn.title = `Delete board: ${board.title}`;
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // VERY Important: Prevent switching board when clicking delete
                    confirmDeleteBoard(board.id, board.title);
                });

                itemDiv.appendChild(boardBtn);
                itemDiv.appendChild(deleteBtn);
                sidebarBoardList.appendChild(itemDiv);
            });
        }

        function renderBoard() {
            boardContainer.innerHTML = '';
            const currentBoard = getCurrentBoard();
            const isLight = body.classList.contains('light-mode');
            if (!currentBoard) { boardContainer.innerHTML = '<p class="text-center text-xl p-10">No board selected.</p>'; currentBoardNameHeader.textContent = 'Go-do'; addColumnBtnGlobal.style.display = 'none'; renderBoardList(); saveAppState(); return; } // Added saveAppState here too
            currentBoardNameHeader.textContent = currentBoard.title;
            addColumnBtnGlobal.style.display = 'block';
            currentBoard.columns.forEach(colData => {
                const colEl = createColumnElement(colData);
                if (colData.width) colEl.style.width = `${colData.width}px`;
                const cInfo = COLUMN_COLORS.find(c => c.value === colData.color) || DEFAULT_COLUMN_COLOR;
                const bgColor = isLight ? cInfo.light : cInfo.value;
                colEl.style.backgroundColor = bgColor;
                const headerColor = getContrastingTextColor(bgColor);
                colEl.querySelector('.column-title').style.color = headerColor;
                colEl.querySelector('.column-menu-btn').style.color = headerColor;
                colEl.querySelector('.column-header').style.borderBottomColor = headerColor === '#f3f4f6' ? '#4b5563' : '#d1d5db';
                boardContainer.appendChild(colEl);
            });
            renderBoardList();
            saveAppState();
        }

        // --- Board Management ---
        function addNewBoard() { const t = prompt("New board name:", "My Board"); if (t && t.trim()) { const b = { id: `board-${appState.nextBoardId++}`, title: t.trim(), columns: [{ id: `col-${appState.nextColumnId++}`, title: 'To Do', tasks: [], width: 300, color: DEFAULT_COLUMN_COLOR.value }] }; appState.boards.push(b); switchBoard(b.id); } }
        function switchBoard(id) { appState.currentBoardId = id; renderBoard(); } // Render will save
        addBoardBtnGlobal.addEventListener('click', addNewBoard);

        function confirmDeleteBoard(boardId, boardTitle) {
            if (confirm(`Are you sure you want to delete the board "${boardTitle}"? This cannot be undone.`)) {
                appState.boards = appState.boards.filter(b => b.id !== boardId);
                if (appState.currentBoardId === boardId) {
                    appState.currentBoardId = appState.boards.length > 0 ? appState.boards[0].id : null;
                }
                renderBoard(); // Re-render everything
            }
        }


        // --- Column Management ---
        function createColumnElement(cData) {
            const div = document.createElement('div'); div.className = 'column'; div.dataset.columnId = cData.id; div.draggable = true;
            div.addEventListener('dragstart', handleColumnDragStart); div.addEventListener('dragend', handleColumnDragEnd);
            div.addEventListener('mousedown', e => { div.draggable = !e.target.closest('input, button, .task-item, .column-title, .new-task-input, .column-menu-btn'); });
            div.addEventListener('mouseup', () => { div.draggable = true; });
            const h = document.createElement('div'); h.className = 'column-header';
            const t = document.createElement('span'); t.className = 'column-title'; t.textContent = cData.title; t.addEventListener('click', () => makeTitleEditable(t, cData.id));
            const m = document.createElement('button'); m.className = 'column-menu-btn'; m.innerHTML = '<i class="fas fa-ellipsis-h"></i>'; m.title = "Options"; m.addEventListener('click', e => { e.stopPropagation(); showColumnContextMenu(e.target, cData.id); });
            h.appendChild(t); h.appendChild(m);
            const l = document.createElement('div'); l.className = 'task-list';
            l.addEventListener('dragover', handleDragOver); l.addEventListener('drop', e => handleTaskDrop(e, cData.id));
            l.addEventListener('dragenter', handleTaskDragEnterColumn); l.addEventListener('dragleave', handleTaskDragLeaveColumn);
            cData.tasks.forEach(tData => l.appendChild(createTaskElement(tData, cData.id)));
            const a = document.createElement('div'); a.className = 'add-card-area';
            const i = document.createElement('input'); i.type = 'text'; i.className = 'new-task-input'; i.placeholder = 'Add a card...';
            i.addEventListener('keypress', e => { if (e.key === 'Enter' && i.value.trim()) { addTaskToColumn(cData.id, i.value.trim()); i.value = ''; } });
            const btn = document.createElement('button'); btn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-md text-sm'; btn.textContent = 'Add Card';
            btn.addEventListener('click', () => { if (i.value.trim()) { addTaskToColumn(cData.id, i.value.trim()); i.value = ''; } });
            a.appendChild(i); a.appendChild(btn);
            div.appendChild(h); div.appendChild(l); div.appendChild(a);
            return div;
        }
        function makeTitleEditable(titleSpan, columnId) { const b = getCurrentBoard(); if (!b) return; const c = b.columns.find(col => col.id === columnId); if (!c) return; const currentTitle = titleSpan.textContent; const input = document.createElement('input'); input.type = 'text'; input.value = currentTitle; input.className = 'column-title-input'; titleSpan.replaceWith(input); input.focus(); input.select(); const save = () => { const newTitle = input.value.trim(); if (newTitle) c.title = newTitle; renderBoard(); }; input.addEventListener('blur', save); input.addEventListener('keypress', e => { if (e.key === 'Enter') input.blur(); }); }
        function addNewColumn() { const b = getCurrentBoard(); if (!b) return; const t = prompt("New list title:", "New List"); if (t && t.trim()) { b.columns.push({ id: `col-${appState.nextColumnId++}`, title: t.trim(), tasks: [], width: 300, color: DEFAULT_COLUMN_COLOR.value }); renderBoard(); } }
        addColumnBtnGlobal.addEventListener('click', addNewColumn);
        function confirmDeleteColumn(id) { if (confirm("Delete this list and all its cards?")) deleteColumn(id); }
        function deleteColumn(id) { const b = getCurrentBoard(); if (b) { b.columns = b.columns.filter(c => c.id !== id); renderBoard(); } }
        function updateColumnColor(id, color) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === id) : null; if (c) { c.color = color; renderBoard(); } }
        function sortColumn(id, type) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === id) : null; if (!c) return; if (type === 'name-az') c.tasks.sort((a, b) => a.text.localeCompare(b.text)); else if (type === 'date-new') c.tasks.sort((a, b) => b.createdAt - a.createdAt); renderBoard(); }
        function clearCompleted(id) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === id) : null; if (!c) return; c.tasks = c.tasks.filter(t => t.subTasks.length === 0 || t.subTasks.some(st => !st.completed)); renderBoard(); }

        // --- Task Management ---
        function createTaskElement(tData, cId) {
            const div = document.createElement('div'); div.className = 'task-item'; div.dataset.taskId = tData.id; div.dataset.columnId = cId; div.draggable = true; div.style.backgroundColor = tData.color || DEFAULT_TASK_COLOR;
            div.addEventListener('contextmenu', e => { e.preventDefault(); hideAllMenus(); currentContextMenuTask = { columnId: cId, taskId: tData.id }; populateAndShowContextMenu(e.clientX, e.clientY, tData); });
            const star = document.createElement('button'); star.className = 'star-btn'; star.innerHTML = '<i class="fas fa-star"></i>'; star.title = "Star this card"; if (tData.isStarred) star.classList.add('starred');
            star.addEventListener('click', e => { e.stopPropagation(); toggleStarTask(cId, tData.id); });
            const main = document.createElement('div'); main.className = 'task-main-content';
            const p = document.createElement('p'); p.className = 'task-text'; p.textContent = tData.text; p.style.color = getContrastingTextColor(tData.color || DEFAULT_TASK_COLOR);
            main.appendChild(p); div.appendChild(star); div.appendChild(main);
            // --- Subtask Form (FIXED) ---
            const subForm = document.createElement('div'); subForm.className = 'add-subtask-form'; subForm.style.display = 'none';
            const subInput = document.createElement('input'); subInput.type = 'text'; subInput.className = 'new-subtask-input'; subInput.placeholder = 'New sub-task...';
            const subBtn = document.createElement('button'); subBtn.className = 'confirm-add-subtask-btn'; subBtn.textContent = 'Add';
            const addAction = () => { if (subInput.value.trim()) { addSubTask(cId, tData.id, subInput.value.trim()); subInput.value = ''; } };
            subInput.addEventListener('keypress', e => { if (e.key === 'Enter') addAction(); });
            subInput.addEventListener('mousedown', e => e.stopPropagation()); // Prevent task drag
            subBtn.addEventListener('click', e => { e.stopPropagation(); addAction(); });
            subForm.appendChild(subInput); subForm.appendChild(subBtn);
            // --- Subtask List (FIXED) ---
            const subList = document.createElement('div'); subList.className = 'subtask-list-container'; subList.style.display = 'none';
            if (tData.subTasks && tData.subTasks.length > 0) {
                 tData.subTasks.forEach(st => subList.appendChild(createSubTaskElement(st, tData.id, cId, tData.color || DEFAULT_TASK_COLOR)));
            }
            // Show subtasks by default if they exist
            if (tData.subTasks?.length > 0) subList.style.display = 'flex';

            div.appendChild(subForm); div.appendChild(subList);
            div.addEventListener('dragstart', handleTaskDragStart); div.addEventListener('dragend', handleTaskDragEnd);
            return div;
        }
        function addTaskToColumn(cId, text) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === cId) : null; if (c) { c.tasks.push({ id: `task-${appState.nextTaskId++}`, text, color: DEFAULT_TASK_COLOR, subTasks: [], isStarred: false, createdAt: Date.now() }); renderBoard(); } }
        function deleteTask(cId, tId) { const b = getCurrentBoard(); const c = b ? b.columns.find(col => col.id === cId) : null; if (c) { c.tasks = c.tasks.filter(t => t.id !== tId); renderBoard(); } }
        function updateTaskColor(cId, tId, color) { const t = getTaskById(cId, tId); if (t) { t.color = color; renderBoard(); } }
        function toggleStarTask(cId, tId) { const t = getTaskById(cId, tId); if (t) { t.isStarred = !t.isStarred; renderBoard(); } }

        // --- Sub-task Management (FIXED) ---
        function toggleSubtaskVisibility(cId, tId) {
            const el = document.querySelector(`.task-item[data-task-id="${tId}"]`); if (!el) return;
            const f = el.querySelector('.add-subtask-form'); const l = el.querySelector('.subtask-list-container'); if (!f || !l) return;
            const hidden = f.style.display === 'none';
            f.style.display = hidden ? 'flex' : 'none'; // Show form
            l.style.display = hidden ? 'flex' : 'none'; // Always show/hide list with form
            if(hidden) f.querySelector('input').focus(); // Focus input when shown
        }
        function createSubTaskElement(stData, tId, cId, pColor) {
             const item = document.createElement('div'); item.className = 'subtask-item'; item.dataset.subtaskId = stData.id;
             const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = stData.completed; chk.addEventListener('change', () => toggleSubTaskComplete(cId, tId, stData.id));
             chk.addEventListener('mousedown', e => e.stopPropagation()); // Prevent task drag
             const span = document.createElement('span'); span.textContent = stData.text; if (stData.completed) span.classList.add('completed'); span.style.color = getContrastingTextColor(pColor);
             const btn = document.createElement('button'); btn.className = 'delete-subtask-btn'; btn.innerHTML = '<i class="fas fa-times"></i>'; btn.addEventListener('click', () => deleteSubTask(cId, tId, stData.id));
             btn.addEventListener('mousedown', e => e.stopPropagation()); // Prevent task drag
             item.appendChild(chk); item.appendChild(span); item.appendChild(btn); return item;
        }
        function addSubTask(cId, tId, text) { const t = getTaskById(cId, tId); if (!t) return; if (!t.subTasks) t.subTasks = []; t.subTasks.push({ id: `subtask-${appState.nextSubTaskId++}`, text, completed: false }); renderBoard(); }
        function toggleSubTaskComplete(cId, tId, stId) { const t = getTaskById(cId, tId); const st = t ? t.subTasks.find(s => s.id === stId) : null; if (st) { st.completed = !st.completed; renderBoard(); } }
        function deleteSubTask(cId, tId, stId) { const t = getTaskById(cId, tId); if (t) { t.subTasks = t.subTasks.filter(s => s.id !== stId); renderBoard(); } }


        // --- Context Menu Management ---
        function hideAllMenus() { taskColorContextMenu.style.display = 'none'; columnContextMenu.style.display = 'none'; }
        function positionMenu(menuEl, x, y) { const rect = menuEl.getBoundingClientRect(); x = Math.min(x, window.innerWidth - rect.width - 5); y = Math.min(y, window.innerHeight - rect.height - 5); menuEl.style.left = `${x}px`; menuEl.style.top = `${y}px`; menuEl.style.display = 'flex'; }
        function populateAndShowContextMenu(x, y, tData) {
            taskColorContextMenu.innerHTML = ''; const { columnId, taskId } = currentContextMenuTask;
            const items = [ { text: 'Sub-tasks', icon: 'fa-tasks', action: () => toggleSubtaskVisibility(columnId, taskId) }, { text: 'Delete Card', icon: 'fa-trash-alt', action: () => deleteTask(columnId, taskId), isDelete: true } ];
            items.forEach(i => { const d = document.createElement('div'); d.className = `menu-item ${i.isDelete ? 'delete' : ''}`; d.innerHTML = `<i class="fas ${i.icon}"></i><span>${i.text}</span>`; d.addEventListener('click', () => { i.action(); hideAllMenus(); }); taskColorContextMenu.appendChild(d); });
            taskColorContextMenu.appendChild(document.createElement('hr')).className = 'menu-divider';
            PRESET_COLORS.forEach(c => { const d = document.createElement('div'); d.className = 'menu-item'; const s = document.createElement('div'); s.className = 'context-menu-color-swatch'; s.style.backgroundColor = c.value; d.innerHTML = `<span>${c.name}</span>`; if (c.value === tData.color) d.style.fontWeight = 'bold'; d.prepend(s); d.addEventListener('click', () => { updateTaskColor(columnId, taskId, c.value); hideAllMenus(); }); taskColorContextMenu.appendChild(d); });
            positionMenu(taskColorContextMenu, x, y);
        }
       function showColumnContextMenu(btnEl, cId) {
            hideAllMenus(); currentContextMenuColumn.columnId = cId; columnContextMenu.innerHTML = '';
            const items = [ { text: 'Rename List', icon: 'fa-edit', action: () => { const t = document.querySelector(`.column[data-column-id="${cId}"] .column-title`); if (t) makeTitleEditable(t, cId); } }, { text: 'Change Color', icon: 'fa-palette', submenu: COLUMN_COLORS }, { text: 'Sort by Name', icon: 'fa-sort-alpha-down', action: () => sortColumn(cId, 'name-az') }, { text: 'Sort by Date', icon: 'fa-sort-numeric-down', action: () => sortColumn(cId, 'date-new') }, { text: 'Clear Completed', icon: 'fa-broom', action: () => clearCompleted(cId) }, { text: 'Delete List', icon: 'fa-trash-alt', action: () => confirmDeleteColumn(cId), isDelete: true } ];
            items.forEach((i, idx) => {
                if (idx === 1 || idx === 5) columnContextMenu.appendChild(document.createElement('hr')).className = 'menu-divider';
                const d = document.createElement('div'); d.className = `menu-item ${i.isDelete ? 'delete' : ''} ${i.submenu ? 'submenu' : ''}`; d.innerHTML = `<i class="fas ${i.icon}"></i><span>${i.text}</span>`;
                if (i.submenu) { const sub = document.createElement('div'); sub.className = 'menu-base submenu-content'; i.submenu.forEach(col => { const subItem = document.createElement('div'); subItem.className = 'menu-item'; const s = document.createElement('div'); s.className = 'context-menu-color-swatch'; s.style.backgroundColor = col.value; subItem.innerHTML = `<span>${col.name}</span>`; subItem.prepend(s); subItem.addEventListener('click', e => { e.stopPropagation(); updateColumnColor(cId, col.value); hideAllMenus(); }); sub.appendChild(subItem); }); d.appendChild(sub); }
                else { d.addEventListener('click', () => { i.action(); hideAllMenus(); }); }
                columnContextMenu.appendChild(d);
            });
            const rect = btnEl.getBoundingClientRect(); positionMenu(columnContextMenu, rect.left, rect.bottom + 5);
        }


        // --- Drag and Drop (No changes needed, assumed working) ---
        function handleTaskDragStart(e) { const t = e.target.closest('.task-item'); if (!t || e.target.closest('input, button')) { e.preventDefault(); return; } draggedTask = t; sourceColumnId = t.dataset.columnId; e.dataTransfer.setData('text/plain', t.dataset.taskId); e.dataTransfer.effectAllowed = 'move'; setTimeout(() => t.classList.add('dragging'), 0); }
        function handleTaskDragEnd() { if (draggedTask) draggedTask.classList.remove('dragging'); draggedTask = null; sourceColumnId = null; document.querySelectorAll('.column.drag-over').forEach(c => c.classList.remove('drag-over')); }
        function handleDragOver(e) { e.preventDefault(); if (draggedTask) e.dataTransfer.dropEffect = 'move'; }
        function handleTaskDragEnterColumn(e) { if (draggedTask) e.target.closest('.column')?.classList.add('drag-over'); }
        function handleTaskDragLeaveColumn(e) { if (draggedTask && !e.currentTarget.contains(e.relatedTarget)) e.currentTarget.closest('.column')?.classList.remove('drag-over'); }
        function handleTaskDrop(e, tColId) {
            e.preventDefault(); e.target.closest('.column')?.classList.remove('drag-over'); if (!draggedTask || !sourceColumnId) return;
            const b = getCurrentBoard(); if (!b) return; const tId = draggedTask.dataset.taskId; const sCol = b.columns.find(c => c.id === sourceColumnId); const sIdx = sCol ? sCol.tasks.findIndex(t => t.id === tId) : -1; if (sIdx === -1) return;
            const [tData] = sCol.tasks.splice(sIdx, 1); const tCol = b.columns.find(c => c.id === tColId); if (!tCol) { sCol.tasks.splice(sIdx, 0, tData); renderBoard(); return; }
            const tList = e.target.closest('.column').querySelector('.task-list'); const refNode = Array.from(tList.querySelectorAll('.task-item:not(.dragging)')).find(el => e.clientY < el.getBoundingClientRect().top + el.offsetHeight / 2);
            const refIdx = refNode ? tCol.tasks.findIndex(t => t.id === refNode.dataset.taskId) : -1;
            if (refIdx !== -1) tCol.tasks.splice(refIdx, 0, tData); else tCol.tasks.push(tData);
            renderBoard();
        }
        function handleColumnDragStart(e) { /* ... */ }
        function handleColumnDragEnd() { /* ... */ }
        function handleColumnDragOver(e) { /* ... */ }
        function handleColumnDrop(e) { /* ... */ }

        // --- Global Listeners ---
        document.addEventListener('click', (e) => { if (!taskColorContextMenu.contains(e.target)) taskColorContextMenu.style.display = 'none'; if (!columnContextMenu.contains(e.target) && !e.target.closest('.column-menu-btn')) columnContextMenu.style.display = 'none'; if (!sidebar.contains(e.target) && !e.target.closest('#openSidebarBtn') && !sidebar.classList.contains('-translate-x-full')) closeSidebar(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { hideAllMenus(); closeSidebar(); } });

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', loadAppState);

    </script>
</body>
</html>